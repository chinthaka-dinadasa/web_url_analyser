name: Golang Web Analyser - CI Prod

on:
  push:
    branches: [ "main" ]

jobs:

  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25.3'

    - name: Build
      run: go build -v ./...

    - name: Test
      run: go test -v ./...

  docker-build-and-push:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.DOCKER_REGISTRY_TOKEN }}
        
    - name: Generate semantic version
      id: version
      run: |
        # Debug: Show all tags
        echo "All tags in repository:"
        git tag --list
        
        # Debug: Show tag count
        TAG_COUNT=$(git tag --list | wc -l)
        echo "Tag count: $TAG_COUNT"
        
        # Check if any tags exist using a more reliable method
        if [ "$TAG_COUNT" -gt 0 ]; then
          # Tags exist, get the latest one
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null)
          echo "Latest tag found: $LATEST_TAG"
        else
          # No tags exist, start with v0.0.0
          LATEST_TAG="v0.0.0"
          echo "No tags found, starting with: $LATEST_TAG"
        fi
        
        # Extract version numbers
        MAJOR=$(echo $LATEST_TAG | sed 's/v\([0-9]*\)\.\([0-9]*\)\.\([0-9]*\)/\1/')
        MINOR=$(echo $LATEST_TAG | sed 's/v\([0-9]*\)\.\([0-9]*\)\.\([0-9]*\)/\2/')
        PATCH=$(echo $LATEST_TAG | sed 's/v\([0-9]*\)\.\([0-9]*\)\.\([0-9]*\)/\3/')
        
        echo "Extracted version components:"
        echo "  MAJOR: $MAJOR"
        echo "  MINOR: $MINOR"
        echo "  PATCH: $PATCH"
        
        # Increment patch version
        NEW_PATCH=$((PATCH + 1))
        NEW_VERSION="v${MAJOR}.${MINOR}.${NEW_PATCH}"
        
        echo "version=${NEW_VERSION}" >> $GITHUB_OUTPUT
        echo "Generated version: ${NEW_VERSION}"
        
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ghcr.io/chinthaka-dinadasa/web_url_analyser
          ghcr.io/chinthaka-dinadasa/web_url_analyser:${{ steps.version.outputs.version }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64
        
    - name: Create and push git tag
      run: |
        git config --local user.email "sendtoclabz@gmail.com"
        git config --local user.name "chinthaka-dinadasa"
        git tag -a "${{ steps.version.outputs.version }}" -m "Release ${{ steps.version.outputs.version }}"
        git push origin "${{ steps.version.outputs.version }}"
        
    
    - name: Create GitHub release with auto notes
      run: |
        gh release create ${{ steps.version.outputs.version }} --generate-notes
      env:
        GITHUB_TOKEN: ${{ secrets.DOCKER_REGISTRY_TOKEN }}
